<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Statistics</title>
    <link rel="stylesheet" href="/pages/staff/CSS/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="navbar-placeholder"></div>
    <script src="/loadlayout1"></script>
    <div class="container">
        <!-- เพิ่ม dropdown สำหรับการเลือกปี -->
        <div class="year-selection">
            <label for="yearSelect">Select Year:</label>
            <select id="yearSelect">
                <!-- ปีที่สามารถเลือกได้จะถูกเพิ่มโดย JavaScript -->
            </select>
        </div>

        <div class="total">
            <div class="chart total-chart">
                <canvas id="totalChart"></canvas>
            </div>
            <div class="total-details">
                <div class="detail blue">
                    <p>Total of student</p>
                    <p id="totalStudent" class="number"></p>
                </div>
                <div class="detail red">
                    <p>Total of Retire</p>
                    <p id="totalRetire" class="number"></p>
                </div>
                <div class="detail green">
                    <p>Total of Studying</p>
                    <p id="totalStudying" class="number"></p>
                </div>
                <div class="detail yellow">
                    <p>Total of Graduate</p>
                    <p id="totalGraduate" class="number"></p>
                </div>
            </div>
        </div>

        <div class="category">
            <div class="category-item">
                <div class="chart msc-chart">
                    <canvas id="mscChart"></canvas>
                </div>
                <p>M.Sc.</p>
                <p class="total-student">TOTAL: Student <span id="mscTotal"></span></p>
                <p class="percentages">
                    <span id="mscRetiredPerc">0%</span> Retired<br>
                    <span id="mscStudyingPerc">0%</span> Studying<br>
                    <span id="mscGraduatePerc">0%</span> Graduates
                </p>
                <div class="details">
                    <div class="detail blue">
                        <p>Total of studying</p>
                        <p id="mscStudying" class="number"></p>
                    </div>
                    <div class="detail red">
                        <p>Total of Retired</p>
                        <p id="mscRetired" class="number"></p>
                    </div>
                    <div class="detail yellow">
                        <p>Total of Graduate</p>
                        <p id="mscGraduate" class="number"></p>
                    </div>
                </div>
            </div>

            <div class="category-item">
                <div class="chart meng-chart">
                    <canvas id="mengChart"></canvas>
                </div>
                <p>M.Eng.</p>
                <p class="total-student">TOTAL: Student <span id="mengTotal"></span></p>
                <p class="percentages">
                    <span id="mengRetiredPerc">0%</span> Retired<br>
                    <span id="mengStudyingPerc">0%</span> Studying<br>
                    <span id="mengGraduatePerc">0%</span> Graduates
                </p>
                <div class="details">
                    <div class="detail blue">
                        <p>Total of studying</p>
                        <p id="mengStudying" class="number"></p>
                    </div>
                    <div class="detail red">
                        <p>Total of Retired</p>
                        <p id="mengRetired" class="number"></p>
                    </div>
                    <div class="detail yellow">
                        <p>Total of Graduate</p>
                        <p id="mengGraduate" class="number"></p>
                    </div>
                </div>
            </div>

            <div class="category-item">
                <div class="chart phd-chart">
                    <canvas id="phdChart"></canvas>
                </div>
                <p>Ph.D.</p>
                <p class="total-student">TOTAL: Student <span id="phdTotal"></span></p>
                <p class="percentages">
                    <span id="phdRetiredPerc">0%</span> Retired<br>
                    <span id="phdStudyingPerc">0%</span> Studying<br>
                    <span id="phdGraduatePerc">0%</span> Graduates
                </p>
                <div class="details">
                    <div class="detail blue">
                        <p>Total of studying</p>
                        <p id="phdStudying" class="number"></p>
                    </div>
                    <div class="detail red">
                        <p>Total of Retired</p>
                        <p id="phdRetired" class="number"></p>
                    </div>
                    <div class="detail yellow">
                        <p>Total of Graduate</p>
                        <p id="phdGraduate" class="number"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            let totalChart, mscChart, mengChart, phdChart;

            // ฟังก์ชันสำหรับการล้างข้อมูลเก่า
            function clearDashboard() {
                if (totalChart) totalChart.destroy();
                if (mscChart) mscChart.destroy();
                if (mengChart) mengChart.destroy();
                if (phdChart) phdChart.destroy();

                document.getElementById('totalStudent').textContent = '';
                document.getElementById('totalRetire').textContent = '';
                document.getElementById('totalStudying').textContent = '';
                document.getElementById('totalGraduate').textContent = '';
                document.getElementById('mscStudying').textContent = '';
                document.getElementById('mscRetired').textContent = '';
                document.getElementById('mscGraduate').textContent = '';
                document.getElementById('mscTotal').textContent = '';
                document.getElementById('mscStudyingPerc').textContent = '0%';
                document.getElementById('mscRetiredPerc').textContent = '0%';
                document.getElementById('mscGraduatePerc').textContent = '0%';
                document.getElementById('mengStudying').textContent = '';
                document.getElementById('mengRetired').textContent = '';
                document.getElementById('mengGraduate').textContent = '';
                document.getElementById('mengTotal').textContent = '';
                document.getElementById('mengStudyingPerc').textContent = '0%';
                document.getElementById('mengRetiredPerc').textContent = '0%';
                document.getElementById('mengGraduatePerc').textContent = '0%';
                document.getElementById('phdStudying').textContent = '';
                document.getElementById('phdRetired').textContent = '';
                document.getElementById('phdGraduate').textContent = '';
                document.getElementById('phdTotal').textContent = '';
                document.getElementById('phdStudyingPerc').textContent = '0%';
                document.getElementById('phdRetiredPerc').textContent = '0%';
                document.getElementById('phdGraduatePerc').textContent = '0%';
            }

            // ฟังก์ชันสำหรับการเพิ่มตัวเลือกปีใน dropdown
            async function populateYearSelect() {
                const years = await fetch('/years').then(res => res.json());
                const yearSelect = document.getElementById('yearSelect');

                // เรียงลำดับปีจากล่าสุดไปยังเก่าสุด
                years.sort((a, b) => b - a);

                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }

            // ฟังก์ชันสำหรับการดึงข้อมูลตามปีที่เลือก
            async function fetchDataByYear(year) {
                const response = await fetch(`/statistics?year=${year}`);
                const data = await response.json();

                clearDashboard();

                if (data.status === 'success') {
                    const stats = data.data;

                    let totalStudent = 0;
                    let totalRetire = 0;
                    let totalStudying = 0;
                    let totalGraduate = 0;

                    // ฟังก์ชันสำหรับอัพเดทข้อมูลตามโปรแกรม
                    function updateProgramStats(program, prefix) {
                        const programStats = stats.find(stat => stat.PROGRAM === program);

                        if (programStats) {
                            document.getElementById(`${prefix}Studying`).textContent = programStats.NORMAL;
                            document.getElementById(`${prefix}Retired`).textContent = programStats.CANDIDATE;
                            document.getElementById(`${prefix}Graduate`).textContent = programStats.GRADUATE;
                            document.getElementById(`${prefix}Total`).textContent = programStats.TOTAL;

                            const studyingPerc = (programStats.NORMAL / programStats.TOTAL) * 100;
                            const retiredPerc = (programStats.CANDIDATE / programStats.TOTAL) * 100;
                            const graduatePerc = (programStats.GRADUATE / programStats.TOTAL) * 100;

                            document.getElementById(`${prefix}StudyingPerc`).textContent = `${studyingPerc.toFixed(2)}%`;
                            document.getElementById(`${prefix}RetiredPerc`).textContent = `${retiredPerc.toFixed(2)}%`;
                            document.getElementById(`${prefix}GraduatePerc`).textContent = `${graduatePerc.toFixed(2)}%`;

                            totalStudent += parseInt(programStats.TOTAL);
                            totalRetire += parseInt(programStats.CANDIDATE);
                            totalStudying += parseInt(programStats.NORMAL);
                            totalGraduate += parseInt(programStats.GRADUATE);
                        } else {
                            document.getElementById(`${prefix}Studying`).textContent = '0';
                            document.getElementById(`${prefix}Retired`).textContent = '0';
                            document.getElementById(`${prefix}Graduate`).textContent = '0';
                            document.getElementById(`${prefix}Total`).textContent = '0';
                            document.getElementById(`${prefix}StudyingPerc}`).textContent = '0%';
                            document.getElementById(`${prefix}RetiredPerc}`).textContent = '0%';
                            document.getElementById(`${prefix}GraduatePerc}`).textContent = '0%';
                        }
                    }

                    updateProgramStats(605200303, 'msc');
                    updateProgramStats(605120902, 'meng');
                    updateProgramStats(605200102, 'phd');

                    document.getElementById('totalStudent').textContent = totalStudent;
                    document.getElementById('totalRetire').textContent = totalRetire;
                    document.getElementById('totalStudying').textContent = totalStudying;
                    document.getElementById('totalGraduate').textContent = totalGraduate;

                    // Initialize total chart
                    const totalCtx = document.getElementById('totalChart').getContext('2d');
                    totalChart = new Chart(totalCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Retired', 'Studying', 'Graduates'],
                            datasets: [{
                                data: [totalRetire, totalStudying, totalGraduate],
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });

                    // Initialize individual program charts
                    function initChart(ctxId, programStats) {
                        const ctx = document.getElementById(ctxId).getContext('2d');
                        if (!programStats) {
                            return new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Retired', 'Studying', 'Graduates'],
                                    datasets: [{
                                        data: [0, 0, 0],
                                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            });
                        }
                        return new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Retired', 'Studying', 'Graduates'],
                                datasets: [{
                                    data: [programStats.CANDIDATE, programStats.NORMAL, programStats.GRADUATE],
                                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }

                    mscChart = initChart('mscChart', stats.find(stat => stat.PROGRAM === 605200303));
                    mengChart = initChart('mengChart', stats.find(stat => stat.PROGRAM === 605120902));
                    phdChart = initChart('phdChart', stats.find(stat => stat.PROGRAM === 605200102));
                } else {
                    console.error('Failed to load statistics:', data.message);
                }
            }

            // Event listener สำหรับการเลือกปี
            document.getElementById('yearSelect').addEventListener('change', (event) => {
                const selectedYear = event.target.value;
                fetchDataByYear(selectedYear);
            });

            // เรียกใช้ฟังก์ชันเพื่อเพิ่มตัวเลือกปีใน dropdown
            await populateYearSelect();
            // ดึงข้อมูลตามปีแรกที่มีอยู่ใน dropdown
            const firstYear = document.getElementById('yearSelect').value;
            await fetchDataByYear(firstYear);
        });
    </script>
</body>
</html>

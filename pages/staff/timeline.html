<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Timeline Guide to Graduate</title>
        <link rel="stylesheet" href="/pages/CSS/tl.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body>
        <div id="navbar-placeholder"></div>
        <script src="/loadlayout1"></script>
        <div>
            <div class="header">
                <h1>Timeline Guide to Graduate</h1>
                <div class="buttons">
                    <button>Notification</button>
                    <button id="noteButton"
                        style="background-color: #007bff;color: white;">Note</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>TIMELINE</th>
                        <th>STATUS DATE</th>
                        <th>STATUS</th>
                    </tr>
                </thead>
                <tbody id="timeline-body">
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div class="precautions">
                <h2>Precautions students</h2>
            </div>
            <div class="status-explanation">
                <span class="status safe">Safe</span>
                <span class="status warning">Warning</span>
                <span class="status retried">Retried</span>
            </div>
            <div class="precaution-list">
                <!-- Precaution items will be inserted here by JavaScript -->
                <div class="precaution" id="academic-year-status">1. Academic
                    year</div>
                <div class="precaution" id="qualifying-exam-status">2.
                    Qualifying exam</div>
                <div class="precaution" id="proposal-test-status">3. Proposal
                    test</div>
                <div class="precaution" id="english-proficiency-status">4.
                    English proficiency score</div>
                <div class="precaution safe">5. Take a leave</div>
                <div class="precaution safe">6. GPAX > 3.00</div>
                <div class="precaution warning">7. Get "U" 2 times</div>
                <div class="precaution safe">8. Corrupt</div>
                <div class="precaution safe">9. Payment tuition fees</div>
            </div>
            <br>
        </div>
        <script>
        async function fetchUserData() {
            try {
                const response = await fetch('/getuser/3666'); // ใช้ ID แทน USERNAME
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('Data received:', data); // Add this line to debug
                    populateTable(data.user, data.researchStatus, data.studentData, data.statusEthicDate, data.statusAdvisorDate, data.statusDefenseDate, data.researchModifyDate);
                } else {
                    console.error(data.message);
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString.trim() === '') return 'N/A';

            const thaiMonths = {
                'ม.ค.': '01',
                'ก.พ.': '02',
                'มี.ค.': '03',
                'เม.ย.': '04',
                'พ.ค.': '05',
                'มิ.ย.': '06',
                'ก.ค.': '07',
                'ส.ค.': '08',
                'ก.ย.': '09',
                'ต.ค.': '10',
                'พ.ย.': '11',
                'ธ.ค.': '12'
            };

            const parts = dateString.trim().split(' ');
            if (parts.length < 4) return 'N/A';

            const day = parts[0].padStart(2, '0');
            const monthThai = parts[1];
            const year = parts[3]; 

            const month = thaiMonths[monthThai];
            if (!month) return 'N/A';

            return `${day}-${month}-${year}`;
        }

        function populateTable(user, researchStatus, studentData, statusEthicDate, statusAdvisorDate, statusDefenseDate, researchModifyDate) {
            const statusBits = getStatusBits(user.STATUS);
            const timelineBody = document.getElementById('timeline-body');
            
            // คำนวณสถานะสีของ "Academic year"
            const startYear = parseInt(studentData.START_YEAR, 10);
            const finishYear = studentData.FINISH_YEAR ? parseInt(studentData.FINISH_YEAR, 10) : null;
            const currentYear = new Date().getFullYear();
            let academicStatus = 'safe';
            
            if (finishYear) {
                academicStatus = 'safe';
            } else if (currentYear - startYear >= 2) {
                academicStatus = 'retried';
            } else if (currentYear - startYear === 1) {
                academicStatus = 'warning';
            }

            // คำนวณสถานะสีของ "Qualifying exam"
            const ethicsTrainDate = formatDate(statusEthicDate);
            let qualifyingExamStatus = 'warning';
            
            if (ethicsTrainDate && ethicsTrainDate.trim() !== 'N/A') {
                qualifyingExamStatus = 'safe';
            }

            // คำนวณสถานะสีของ "Proposal test"
            let proposalTestStatus = 'warning';
            if (researchStatus >= 3) {
                proposalTestStatus = 'safe';
            }

            // คำนวณสถานะสีของ "English proficiency score"
            const etDate = studentData.ET_DATE;
            let englishProficiencyStatus = 'warning';
            
            if (etDate && etDate.trim()) {
                englishProficiencyStatus = 'safe';
            }

            const advisorDate = formatDate(statusAdvisorDate);
            const defenseDate = formatDate(statusDefenseDate);
            const publishDate = formatDate(researchModifyDate);

            timelineBody.innerHTML = `
                <tr>
                    <td>1 Research ethics training</td>
                    <td>${ethicsTrainDate}</td>
                    <td><span class="status ${getStatusClass(statusBits[10], 'ethics')}">${getStatusText(statusBits[10], 'ethics')}</span></td>
                </tr>
                <tr>
                    <td>2 Appoint a consultant</td>
                    <td>${advisorDate}</td>
                    <td><span class="status ${researchStatus > 2 ? 'pass' : 'waiting'}">${researchStatus > 2 ? 'PASS' : 'WAITING'}</span></td>
                </tr>
                <tr>
                    <td>3 Propose an outline</td>
                    <td></td>
                    <td><span class="status ${researchStatus > 3 ? 'pass' : 'waiting'}">${researchStatus > 3 ? 'PASS' : 'WAITING'}</span></td>
                </tr>
                <tr>
                    <td>4 Comprehensive examination</td>
                    <td></td>
                    <td><span class="status ${getStatusClass([statusBits[4], statusBits[5]], 'comprehensive')}">${getStatusText([statusBits[4], statusBits[5]], 'comprehensive')}</span></td>
                </tr>
                <tr>
                    <td>5 Publish research results</td>
                    <td>${publishDate}</td>
                    <td><span class="status ${getStatusClass(statusBits[6], 'publish')}">${getStatusText(statusBits[6], 'publish')}</span></td>
                </tr>
                <tr>
                    <td>6 Defense exam</td>
                    <td>${defenseDate}</td>
                    <td><span class="status ${researchStatus > 6 ? 'pass' : 'waiting'}">${researchStatus > 6 ? 'PASS' : 'WAITING'}</span></td>
                </tr>
                <tr>
                    <td>7 Send printing format check</td>
                    <td></td>
                    <td><span class="status ${researchStatus > 7 ? 'pass' : 'waiting'}">${researchStatus > 7 ? 'PASS' : 'WAITING'}</span></td>
                </tr>
            `;

            checkWarnings(startYear, [
                { date: statusEthicDate, status: getStatusClass(statusBits[10], 'ethics') },
                { date: statusAdvisorDate, status: researchStatus > 2 ? 'pass' : 'waiting' },
                { date: 'N/A', status: researchStatus > 3 ? 'pass' : 'waiting' },
                { date: 'N/A', status: getStatusClass([statusBits[4], statusBits[5]], 'comprehensive') },
                { date: researchModifyDate, status: getStatusClass(statusBits[6], 'publish') },
                { date: statusDefenseDate, status: researchStatus > 6 ? 'pass' : 'waiting' },
                { date: 'N/A', status: researchStatus > 7 ? 'pass' : 'waiting' },
            ]);

            // เพิ่มส่วนที่เกี่ยวข้องกับ "Academic year" ลงในหน้าตาราง
            const academicYearDiv = document.getElementById('academic-year-status');
            academicYearDiv.className = `precaution ${academicStatus}`;

            // เพิ่มส่วนที่เกี่ยวข้องกับ "Qualifying exam" ลงในหน้าตาราง
            const qualifyingExamDiv = document.getElementById('qualifying-exam-status');
            qualifyingExamDiv.className = `precaution ${qualifyingExamStatus}`;

            // เพิ่มส่วนที่เกี่ยวข้องกับ "Proposal test" ลงในหน้าตาราง
            const proposalTestDiv = document.getElementById('proposal-test-status');
            proposalTestDiv.className = `precaution ${proposalTestStatus}`;

            // เพิ่มส่วนที่เกี่ยวข้องกับ "English proficiency score" ลงในหน้าตาราง
            const englishProficiencyDiv = document.getElementById('english-proficiency-status');
            englishProficiencyDiv.className = `precaution ${englishProficiencyStatus}`;
        }

        function checkWarnings(startYear, items) {
            const currentYear = new Date().getFullYear();
            if (currentYear - startYear > 1) {
                const hasWarning = items.some(item => item.status === 'waiting');
                if (hasWarning) {
                    Swal.fire({
                        title: 'Warning!',
                        text: 'You have pending tasks that need immediate attention.',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        function getStatusBits(status) {
            const binaryString = Number(status).toString(2).padStart(11, '0');
            return binaryString.split('').reverse().map(Number);
        }

        function getStatusClass(bits, type) {
            switch (type) {
                case 'ethics':
                    return bits === 1 ? 'pass' : 'failed';
                case 'comprehensive':
                    if (bits[0] === 0 && bits[1] === 0) return 'waiting';
                    if (bits[0] === 1 && bits[1] === 0) return 'failed';
                    if (bits[0] === 0 && bits[1] === 1) return 'pass';
                case 'publish':
                    return bits === 1 ? 'pass' : 'waiting';
                default:
                    return '';
            }
        }

        function getStatusText(bits, type) {
            switch (type) {
                case 'ethics':
                    return bits === 1 ? 'PASS' : 'FAILED';
                case 'comprehensive':
                    if (bits[0] === 0 && bits[1] === 0) return 'WAITING';
                    if (bits[0] === 1 && bits[1] === 0) return 'FAILED';
                    if (bits[0] === 0 && bits[1] === 1) return 'PASS';
                case 'publish':
                    return bits === 1 ? 'PASS' : 'WAITING';
                default:
                    return '';
            }
        }

      // Event listener for Note button
document.getElementById('noteButton').addEventListener('click', async () => {
    const { value: text } = await Swal.fire({
        title: 'Add Note',
        input: 'textarea',
        inputLabel: 'Your note',
        inputPlaceholder: 'Type your note here...',
        showCancelButton: true,
    });

    if (text) {
        try {
            const response = await fetch('/updatenote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ note: text, userId: 3666 }) // ส่ง user ID ไปด้วย
            });

            const data = await response.json();

            if (data.status === 'success') {
                Swal.fire('Saved!', 'Your note has been saved.', 'success');
            } else {
                Swal.fire('Error!', 'There was a problem saving your note.', 'error');
            }
        } catch (error) {
            Swal.fire('Error!', 'There was a problem saving your note.', 'error');
        }
    }
});


        fetchUserData();
    </script>
    </body>
</html>

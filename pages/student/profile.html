<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Link to Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kumar+One&display=swap"
      rel="stylesheet"
    />
  </head>

  <style>
    .kumar-one-font {
      font-family: "Kumar One", cursive;
      color: #0054d3;
      font-size: 64px;
    }
    .centered-textp {
      flex-grow: 1;
      display: flex;
      margin-right: 170px;
      justify-content: center;
      align-items: center;
    }

    .hh {
      border-top: 5px solid #0054d3;
      background-color: white;
    }

    .body {
      background-color: #0054d3;
    }

    .advisor,
    .committee,
    .student {
      font-family: "Lalezar", cursive;
      font-weight: bold;
    }

    .committee {
      text-align: end;
    }

    .detail {
      background-color: white;
      margin-top: 100px;
    }
    /* click me */
    .p {
      font-size: 16px;
    }

    .side2 {
      text-align: end;
    }

    .imgedit {
      position: absolute;
      clip-path: circle(50%);
      width: 300px;
    }
    .image-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 180px;
    }

    .studentdetail {
      box-shadow: 4px 4px 8px rgba(1, 1, 1, 0.5);
      width: 90%;
      justify-content: center;
      align-items: center;
    }
    .studentdetail2 {
      width: 90%;
      justify-content: center;
      align-items: center;
    }
    .researchdetail {
      margin-top: 50px;
      background-color: white;
    }

    .publication {
      margin-top: 50px;
      background-color: white;
    }
    .publication2 {
      width: 90%;
      justify-content: center;
      align-items: center;
    }

    .ethics {
      margin-top: 50px;
      background-color: white;
    }
    .ethics2 {
      width: 90%;
      justify-content: center;
      align-items: center;
    }
    .exam {
      margin-top: 50px;
      background-color: white;
    }
    .exam2 {
      width: 90%;
      justify-content: center;
      align-items: center;
    }

    .space {
      font-weight: bold;
      justify-content: space-between;
    }

    .status {
      color: #44b400;
    }

    .dot {
      position: absolute;
      margin-left: 550px;
    }

    .order {
      font-weight: bold;
      width: 10px;
      background-color: rgb(0, 0, 0);
      color: white;
    }

    .order2 {
      font-weight: bold;
      width: 10px;
      background-color: rgb(0, 0, 0);
      color: white;
      margin-left: 620px;
    }
  </style>
  <body class="body">
    <!-- head -->
    <div class="d-flex hh">
      <img class="mt-4 mx-5 mb-4" src="/public/img/it.jpg" alt="" style="width: 120px; height: auto" />
      <div class="centered-textp mt-4">
        <h1 class="kumar-one-font">Profile</h1>
      </div>
    </div>
  
    <!-- detail -->
    <div class="detail container">
      <!-- img profile -->
      <div class="image-container">
        <img id="profileImage" src="/public/img/profileimg.jpg" alt="Profile Image" class="imgedit" />
      </div>
  
      <!-- commitee adviser -->
      <div class="d-flex nameteacher p-3">
        <div class="col-6">
          <!-- Adviser info -->
          <div class="colorr">
            <h1 class="advisor">ADVISOR</h1>
            <div id="advisorContainer"></div> <!-- Adviser data will be inserted here -->
          </div>
        </div>
        <div class="col-6 side2">
          <!-- Committee info -->
          <h1 class="committee">COMMITTEE</h1>
          <div id="committeeContainer"></div> <!-- Committee data will be inserted here -->
        </div>
      </div>
  
      <!-- student detail -->
      <div class="studentdetail container">
        <h1 class="text-center student">STUDENT</h1>
        <div class="p-5" id="studentDetails"></div> <!-- Student data will be inserted here -->
      </div>
  
      <!-- research box -->
      <div class="researchdetail container">
        <h1 class="text-center student">Research topic / Thesis topic / Dissertation topic</h1>
        <div class="studentdetail2 container">
          <div class="d-flex space">
            <p>Research Title:</p>
            <p class="dot">:</p>
            <p id="researchTitle"></p>
          </div>
          <br />
        </div>
      </div>
  
      <!-- Publication box -->
      <div class="publication container">
        <h1 class="text-center student">Publication</h1>
        <div id="publicationContainer"></div> <!-- Publications will be inserted here -->
      </div>
  
      <!-- research ethics -->
      <div class="ethics container">
        <h1 class="text-center student">Research ethics training</h1>
        <div id="ethicsContainer"></div> <!-- Ethics data will be inserted here -->
      </div>
  
      <!-- english exam -->
      <div class="exam container">
        <h1 class="text-center student">English Exam</h1>
        <div id="examContainer"></div> <!-- Exam data will be inserted here -->
      </div>
    </div>
  
    <!-- JavaScript to fetch and display data -->
   <!-- JavaScript to fetch and display data -->
<script>
  async function fetchData() {
    try {
      // Fetch data from the endpoint
      const response = await fetch("/dataprofile/9027/8333");
      const data = await response.json();

    // Define status mapping
const statusMapping = {
  1: 'Processing',
  2: 'Appointed',
  3: 'Cancelled'
};

// Display adviser data
const advisorContainer = document.getElementById('advisorContainer');
const uniqueAdvisorData = {}; // Object to store unique advisor data

// Loop through adviser data
data.adviserData.forEach((advisor, index) => {
  // Find all inner advisers matching the current advisor's ADVISOR_ID
  const innerAdvisors = data.inneradviserData.filter(inner => inner.ADVISOR_ID === advisor.ADVISOR_ID && inner.USER_ID === advisor.USER_ID);
  const extAdvisors = data.extadviserData.filter(ext => ext.ADVISOR_ID === advisor.ADVISOR_ID && ext.USER_ID === advisor.USER_ID);

  let mergedAdvisors = innerAdvisors;

  // If innerAdvisors array is empty, use extAdvisors
  if (innerAdvisors.length === 0) {
    mergedAdvisors = extAdvisors;
  } else {
    // Merge extAdvisors into mergedAdvisors if they are not already included
    extAdvisors.forEach(ext => {
      if (!innerAdvisors.find(inner => inner.USER_ID === ext.USER_ID)) {
        mergedAdvisors.push(ext);
      }
    });
  }

  // Ensure there are inner advisers
  if (mergedAdvisors.length > 0) {
    // Determine position text based on ADVISER_LEVEL
    let positionText = '';
    switch (advisor.ADVISER_LEVEL) {
      case 1:
        positionText = 'Co-Advisor';
        break;
      case 2:
        positionText = 'Main Advisor';
        break;
      default:
        positionText = '';
        break;
    }

    // Store unique advisor data
    mergedAdvisors.forEach((innerAdvisor, innerIndex) => {
      const key = `${advisor.NAME_EN}_${innerIndex}`; // Use a unique key
      if (!uniqueAdvisorData[key]) {
        uniqueAdvisorData[key] = {
          NAME_EN: advisor.NAME_EN,
          positions: [positionText],
          emails: [innerAdvisor.EMAIL || ''], // Store emails as an array for consistency, handle undefined
          phones: [innerAdvisor.PHONE || innerAdvisor.MOBILE || ''], // Prefer PHONE, fallback to MOBILE, handle undefined
          status: advisor.STATUS // Assuming innerAdvisor.STATUS contains the status value (1, 2, 3)
        };
      } else {
        uniqueAdvisorData[key].positions.push(positionText);
        uniqueAdvisorData[key].emails.push(innerAdvisor.EMAIL || ''); // Handle undefined
        uniqueAdvisorData[key].phones.push(innerAdvisor.PHONE || innerAdvisor.MOBILE || ''); // Prefer PHONE, fallback to MOBILE, handle undefined
      }
    });
  }
});

// Create and display HTML for advisors
Object.values(uniqueAdvisorData).forEach((advisor, index) => {
  const emailsText = advisor.emails.join(', '); // Join emails if there are multiple
  const phonesText = advisor.phones.join(', '); // Join phones if there are multiple
  const positionText = advisor.positions.join(', ');
  const statusText = statusMapping[advisor.status] || 'Unknown'; // Get status text from mapping or default to 'Unknown'

  const advisorHTML = `
    <div class="order">${index + 1}</div>
    <p class="p">${advisor.NAME_EN}</p>
    <p class="p">Email: ${emailsText}</p>
    <p class="p">Phone: ${phonesText}</p>
    <p class="p">Position: ${positionText}</p>
    <p class="p">Status: ${statusText}</p>
  `;
  advisorContainer.insertAdjacentHTML('beforeend', advisorHTML);
});







// Display committee data
const committeeContainer = document.getElementById('committeeContainer');
const uniqueCommitteeData = {}; // Object to store unique committee data

// Loop through committee data
data.committeeData.forEach((committee, index) => {
  // Find inner committee matching the current committee's COMMITTEE_ID and USER_ID
  const innerCommittee = data.innercommitteeData.find(inner => inner.COMMITTEE_ID === committee.COMMITTEE_ID && inner.USER_ID === committee.USER_ID);
  const extCommittee = data.extcommitteeData.find(ext => ext.COMMITTEE_ID === committee.COMMITTEE_ID && ext.USER_ID === committee.USER_ID);

  let mergedCommittee = innerCommittee;

  // If innerCommittee is undefined, use extCommittee
  if (!innerCommittee) {
    mergedCommittee = extCommittee;
  }

  if (mergedCommittee) {
    let positionText = '';
    // Determine position text based on COMMITTEE_LEVEL
    switch (committee.COMMITTEE_LEVEL) {
      case 1:
        positionText = 'Co-adviser';
        break;
      case 2:
        positionText = 'Advisor';
        break;
      case 3:
        positionText = 'Examiner';
        break;
      case 4:
        positionText = 'Chairman';
        break;
      default:
        positionText = '';
        break;
    }

    // Store unique committee data
    if (!uniqueCommitteeData[committee.NAME_EN]) {
      uniqueCommitteeData[committee.NAME_EN] = {
        NAME_EN: committee.NAME_EN,
        positions: new Set([positionText]),
        emails: new Set([mergedCommittee.EMAIL || '']), // Handle undefined
        phones: new Set([mergedCommittee.PHONE || mergedCommittee.MOBILE || '']) // Prefer PHONE, fallback to MOBILE, handle undefined
      };
    } else {
      uniqueCommitteeData[committee.NAME_EN].positions.add(positionText);
      uniqueCommitteeData[committee.NAME_EN].emails.add(mergedCommittee.EMAIL || ''); // Handle undefined
      uniqueCommitteeData[committee.NAME_EN].phones.add(mergedCommittee.PHONE || mergedCommittee.MOBILE || ''); // Prefer PHONE, fallback to MOBILE, handle undefined
    }
  }
});

// Create and display HTML for committees
Object.values(uniqueCommitteeData).forEach((committee, index) => {
  const positionText = Array.from(committee.positions).join(', '); // Join positionText with comma
  const emailsText = Array.from(committee.emails).join(', '); // Join emails if there are multiple
  const phonesText = Array.from(committee.phones).join(', '); // Join phones if there are multiple

  const committeeHTML = `
    <div class="order2">${index + 1}</div>
    <p class="p">${committee.NAME_EN}</p>
    <p class="p">Email: ${emailsText}</p>
    <p class="p">Phone: ${phonesText}</p>
    <p class="p">Position: ${positionText}</p>
  `;
  committeeContainer.insertAdjacentHTML('beforeend', committeeHTML);
});





     // Display student data
const studentDetails = document.getElementById('studentDetails');

// Role mapping for demonstration purposes
const roleMapping = {
  1: 'Admin',
  2: 'Advisor',
  3: 'Student',
  4: 'Advisor(ext)',
  5: 'Staff'
};

// Plan mapping based on PLAN_VERSION
const planMapping = {
  71148: 'Plan 1.1, not less than 48 credits',
  71272: 'Plan 1.2, not less than 72 credits',
  72136: 'Plan 2.1, not less than 36 credits',
  72248: 'Plan 2.2, not less than 48 credits',
  52003: 'Plan B, more than 3 credits',
  51112: 'Plan A1, not less than 12 credits',
  51136: 'Plan A1, not less than 36 credits',
  51212: 'Plan A2, not less than 12 credits',
  51218: 'Plan A2, not less than 18 credits',
  51236: 'Plan A2, not less than 36 credits',
  51118: 'Plan A1, not less than 18 credits',
  51223: 'Plan 1.1, not less than 36 credits',
  51224: 'Plan 1.2, not less than 12 credits',
  51215: 'Plan A2, not less than 15 credits',
  51221: 'Plan A2, not less than 21 credits'
};

// Status mapping based on bit positions for study status (bit 2-3)
const studyStatusMapping = {
  0: 'Normally',
  1: 'Finished',
  2: 'Graduate',
  3: 'Retry'
};

data.studentData.forEach(student => {
  // Find the user data matching the student's USER_ID
  const user = data.userData.find(user => user.ID === student.USER_ID);
  let studentID = '';
  let role = '';
  let status = 'N/A';

  if (user) {
    studentID = user.USERNAME || 'N/A';
    role = roleMapping[user.ROLE_ID] || 'N/A';
    status = user.STATUS || 'N/A';
  } else {
    studentID = 'N/A';
    role = 'N/A';
    status = 'N/A';
  }

  // Convert status to binary and pad to at least 11 bits
  const binaryStatus = status !== 'N/A' ? status.toString(2).padStart(11, '0').split('').reverse() : [];

  // Extract bits 2-3 for study status
  const studyStatusBits = status !== 'N/A' ? binaryStatus.slice(1, 3).reverse().join('') : '00';
  const studyStatus = studyStatusMapping[parseInt(studyStatusBits, 2)] || 'Unknown';

  // Retrieve plan description based on PLAN_VERSION
  const planDescription = planMapping[student.PLAN_VERSION] || 'ยังไม่มี';

  const studentHTML = `
    <div class="d-flex space">
      <p>Firstname - Lastname</p>
      <p class="dot">:</p>
      <p>${student.NAME_EN}</p>
    </div>
    <div class="d-flex space">
      <p>Student ID</p>
      <p class="dot">:</p>
      <p>${studentID}</p>
    </div>
    <div class="d-flex space">
      <p>Role</p>
      <p class="dot">:</p>
      <p>${role}</p>
    </div>
    <div class="d-flex space">
      <p>Major</p>
      <p class="dot">:</p>
      <p>ยังไม่มี</p>
    </div>
    <div class="d-flex space">
      <p>Email</p>
      <p class="dot">:</p>
      <p>${student.EMAIL}</p>
    </div>
    <div class="d-flex space">
      <p>Phone</p>
      <p class="dot">:</p>
      <p>${student.MOBILE}</p>
    </div>
    <div class="d-flex space">
      <p>Program</p>
      <p class="dot">:</p>
      <p>ยังไม่มี</p>
    </div>
    <div class="d-flex space">
      <p>School</p>
      <p class="dot">:</p>
      <p>ยังไม่มี</p>
    </div>
    <div class="d-flex space">
      <p>Level of education</p>
      <p class="dot">:</p>
      <p>ยังไม่มี</p>
    </div>
    <div class="d-flex space">
      <p>Study plan</p>
      <p class="dot">:</p>
      <p>${planDescription}</p>
    </div>
    <div class="d-flex space">
      <p>GPAX</p>
      <p class="dot">:</p>
      <p>ยังไม่มี</p>
    </div>
    <div class="d-flex space">
      <p>Start Semester</p>
      <p class="dot">:</p>
      <p>${student.START_TERM}/${student.START_YEAR}</p>
    </div>
    <div class="d-flex space">
      <p>Status of education</p>
      <p class="dot">:</p>
      <p class="status">${studyStatus}</p>
    </div>
  `;
  studentDetails.insertAdjacentHTML('beforeend', studentHTML);
});






      // Display research title
      document.getElementById('researchTitle').textContent = data.researchData.TITLE_EN;
        // Display publication data
      const researchTitle = document.getElementById('researchTitle');
      data.researchData.forEach(research => {
        const researchHTML = `
          <div class="d-flex space">
            <p>Publication No</p>
            <p class="dot">:</p>
            <p>${research.TITLE_EN}</p>
          </div>
        `;
        researchTitle.insertAdjacentHTML('beforeend', researchHTML);
      });

     // Define the mapping for publish status
const publishStatusMapping = {
  0: 'Not Publish',
  1: 'Published'
};

// Retrieve the publication container
const publicationContainer = document.getElementById('publicationContainer');

// Iterate through each publication data and create HTML
data.researchPublishingData.forEach(pub => {
  // Retrieve the publish status description based on PUBLISHING_NO
  const publishStatus = publishStatusMapping[pub.PUBLISHING_NO] || 'Unknown';

  // Create HTML for each publication
  const pubHTML = `
    <div class="d-flex space">
      <p>Publication No</p>
      <p class="dot">:</p>
      <p>${publishStatus}</p>
    </div>
  `;

  // Append the HTML to the publication container
  publicationContainer.insertAdjacentHTML('beforeend', pubHTML);
});


// Status mapping for ethics
const ethicStatusMapping = {
  0: 'Failed',
  1: 'Passed'
};

// Mapping for ETHICS_TYPE
const ethicTypeMapping = {
  0: 'Training-Studying',
  1: 'Training',
  2: 'Studying',
  3: 'Training-Studying'
};

// Select the container where ethics data will be displayed
const ethicsContainer = document.getElementById('ethicsContainer');

data.studentData.forEach(student => {
  // Find the user data matching the student's USER_ID
  const user = data.userData.find(user => user.ID === student.USER_ID);
  let ethicStatus = 'Unknown';

  if (user && user.STATUS !== undefined) {
    // Convert status to binary, pad to at least 12 bits (11 bits + 1 for 0-based index), and reverse for ease of access
    const binaryStatus = user.STATUS.toString(2).padStart(12, '0').split('').reverse();

    // Check the 11th bit (index 10, 0-based)
    const bit11 = binaryStatus[10];
    ethicStatus = ethicStatusMapping[parseInt(bit11, 10)] || 'Unknown';
  }
   // Extract the date part from ETHICS_TRAIN_DATE
   const trainDate = student.ETHICS_TRAIN_DATE.split('.'); // Split by space and take the first part

  // Retrieve the ethic type description
  const ethicType = ethicTypeMapping[student.ETHICS_TYPE] || 'Unknown';

  const ethicHTML = `
    <div class="d-flex space">
      <p>Training status</p>
      <p class="dot">:</p>
      <p class="status">${ethicStatus}</p>
    </div>
    <div class="d-flex space">
      <p>Research ethics status</p>
      <p class="dot">:</p>
      <p class="status">${ethicType}</p>
    </div>
    <div class="d-flex space">
      <p>Training date</p>
      <p class="dot">:</p>
      <p class="">${trainDate}</p>
    </div>
  `;
  ethicsContainer.insertAdjacentHTML('beforeend', ethicHTML);
});



      // Mapping for ET_TYPE and ET_TRANSFER_TYPE
const etTypeMapping = {
  1: 'Other Standard Test',
  2: 'Academic English Class I',
  3: 'Academic English Class II',
  4: 'Other Standard Test'
};

const etTransferTypeMapping = {
  1: 'Transfer',
  2: 'Not Transfer'
};

// Display English exam data
const examContainer = document.getElementById('examContainer');
data.studentData.forEach(exam => {
  // Retrieve the exam type description from mappings
  const etType = etTypeMapping[exam.ET_TYPE] || 'Unknown';
  const etTransferType = etTransferTypeMapping[exam.ET_TRANSFER_TYPE] || 'Unknown';


  let examHTML;
  if (exam.ET_TYPE !== 1) {
  examHTML = `
    <div class="d-flex space">
      <p>English Exam Type</p>
      <p class="dot">:</p>
      <p>${etType} (${etTransferType})</p>
    </div>
    <div class="d-flex space">
      <p>Taken Date</p>
      <p class="dot">:</p>
      <p>${exam.ET_DATE}</p>
    </div>
    <div class="d-flex space">
      <p>More Detail</p>
      <p class="dot">:</p>
      <p>${exam.ET_MORE_DETAIL}</p>
    </div>
    <div class="d-flex space">
      <p>Score</p>
      <p class="dot">:</p>
      <p>${exam.ET_SCORE}</p>
    </div>
    <div class="d-flex space">
      <p>Result submit term</p>
      <p class="dot">:</p>
      <p>${exam.ET_TERM}/${exam.ET_YEAR}</p>
    </div>
  `;
  }else{
    examHTML = `
    <div class="d-flex space">
      <p>English Exam Type</p>
      <p class="dot">:</p>
      <p>${etType}</p>
    </div>
    <div class="d-flex space">
      <p>Taken Date</p>
      <p class="dot">:</p>
      <p>${exam.ET_DATE}</p>
    </div>
    <div class="d-flex space">
      <p>More Detail</p>
      <p class="dot">:</p>
      <p>${exam.ET_MORE_DETAIL}</p>
    </div>
    <div class="d-flex space">
      <p>Score</p>
      <p class="dot">:</p>
      <p>${exam.ET_SCORE}</p>
    </div>
    <div class="d-flex space">
      <p>Result submit term</p>
      <p class="dot">:</p>
      <p>${exam.ET_TERM}/${exam.ET_YEAR}</p>
    </div>
  `;
  }
  examContainer.insertAdjacentHTML('beforeend', examHTML);
});


    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  // Call the fetchData function to load data on page load
  window.onload = fetchData;
</script>
</body>
</html>
